#!/usr/bin/env node

/**
 * ðŸ§ª Private CRM Integration Test Script
 * 
 * This script tests the connection between the public site and private CRM dashboard.
 * Run this to verify that lead transfer is working correctly.
 */

const https = require('https')
const http = require('http')

// Configuration
const CONFIG = {
  // Update these with your actual values
  PRIVATE_CRM_ENDPOINT: process.env.PRIVATE_CRM_ENDPOINT || 'http://localhost:3000/api/receive-lead',
  PRIVATE_CRM_API_KEY: process.env.PRIVATE_CRM_API_KEY || 'test_api_key_12345',
  
  // Test data
  TEST_LEAD: {
    name: "Test User",
    email: "test@example.com",
    company: "Test Construction Co",
    teamSize: "11-25 employees",
    industry: "Commercial",
    interests: "Full platform, Payroll integration, Safety compliance",
    timing: "This week",
    source: "Test Script",
    notes: "This is a test lead generated by the test script",
    timestamp: new Date().toISOString(),
    sessionId: `test_session_${Date.now()}`,
    conversationContext: [
      "User: I need help with employee management",
      "Bot: I can help you with that! Let me schedule a demo",
      "User: That sounds great"
    ]
  }
}

/**
 * Makes HTTP request with promise support
 */
function makeRequest(url, options, data = null) {
  return new Promise((resolve, reject) => {
    const lib = url.startsWith('https:') ? https : http
    
    const req = lib.request(url, options, (res) => {
      let body = ''
      res.on('data', chunk => body += chunk)
      res.on('end', () => {
        try {
          const parsedBody = body ? JSON.parse(body) : {}
          resolve({
            statusCode: res.statusCode,
            headers: res.headers,
            body: parsedBody
          })
        } catch (error) {
          resolve({
            statusCode: res.statusCode,
            headers: res.headers,
            body: body
          })
        }
      })
    })
    
    req.on('error', reject)
    
    if (data) {
      req.write(JSON.stringify(data))
    }
    
    req.end()
  })
}

/**
 * Tests GET endpoint (connection test)
 */
async function testConnection() {
  console.log('ðŸ” Testing connection to private CRM...')
  console.log(`ðŸ“¡ Endpoint: ${CONFIG.PRIVATE_CRM_ENDPOINT}`)
  
  try {
    const response = await makeRequest(CONFIG.PRIVATE_CRM_ENDPOINT, {
      method: 'GET',
      headers: {
        'X-API-Key': CONFIG.PRIVATE_CRM_API_KEY,
        'User-Agent': 'Constructify-Test-Script/1.0'
      }
    })
    
    if (response.statusCode === 200) {
      console.log('âœ… Connection successful!')
      console.log(`ðŸ“Š Response:`, response.body)
      return true
    } else if (response.statusCode === 401) {
      console.log('ðŸš« Authentication failed - check your API key')
      console.log(`ðŸ”‘ Using API Key: ${CONFIG.PRIVATE_CRM_API_KEY.substring(0, 8)}...`)
      return false
    } else {
      console.log(`âŒ Connection failed with status ${response.statusCode}`)
      console.log('ðŸ“„ Response:', response.body)
      return false
    }
  } catch (error) {
    console.log('âŒ Connection error:', error.message)
    return false
  }
}

/**
 * Tests POST endpoint (lead submission)
 */
async function testLeadSubmission() {
  console.log('\nðŸ“¤ Testing lead submission...')
  console.log('ðŸ‘¤ Test Lead Data:', CONFIG.TEST_LEAD)
  
  try {
    const response = await makeRequest(CONFIG.PRIVATE_CRM_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': CONFIG.PRIVATE_CRM_API_KEY,
        'User-Agent': 'Constructify-Test-Script/1.0'
      }
    }, CONFIG.TEST_LEAD)
    
    if (response.statusCode === 200) {
      console.log('âœ… Lead submission successful!')
      console.log('ðŸŽ¯ Lead Score:', response.body.leadScore)
      console.log('ðŸ†” Lead ID:', response.body.leadId)
      
      if (response.body.leadScore?.isHotLead) {
        console.log('ðŸ”¥ HOT LEAD DETECTED! This lead should receive immediate follow-up.')
      }
      
      return true
    } else if (response.statusCode === 401) {
      console.log('ðŸš« Authentication failed during lead submission')
      return false
    } else if (response.statusCode === 400) {
      console.log('âŒ Validation failed:')
      console.log('ðŸ“‹ Errors:', response.body.details || response.body.error)
      return false
    } else {
      console.log(`âŒ Lead submission failed with status ${response.statusCode}`)
      console.log('ðŸ“„ Response:', response.body)
      return false
    }
  } catch (error) {
    console.log('âŒ Lead submission error:', error.message)
    return false
  }
}

/**
 * Tests invalid API key (security test)
 */
async function testSecurity() {
  console.log('\nðŸ”’ Testing security (invalid API key)...')
  
  try {
    const response = await makeRequest(CONFIG.PRIVATE_CRM_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': 'invalid_key_12345',
        'User-Agent': 'Constructify-Test-Script/1.0'
      }
    }, CONFIG.TEST_LEAD)
    
    if (response.statusCode === 401) {
      console.log('âœ… Security test passed - invalid API key rejected')
      return true
    } else {
      console.log(`âŒ Security test failed - expected 401, got ${response.statusCode}`)
      return false
    }
  } catch (error) {
    console.log('âŒ Security test error:', error.message)
    return false
  }
}

/**
 * Tests malformed data (validation test)
 */
async function testValidation() {
  console.log('\nðŸ§ª Testing data validation...')
  
  const invalidLead = {
    name: "", // Invalid: empty name
    email: "invalid-email", // Invalid: bad email format
    // Missing required fields
  }
  
  try {
    const response = await makeRequest(CONFIG.PRIVATE_CRM_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': CONFIG.PRIVATE_CRM_API_KEY,
        'User-Agent': 'Constructify-Test-Script/1.0'
      }
    }, invalidLead)
    
    if (response.statusCode === 400) {
      console.log('âœ… Validation test passed - invalid data rejected')
      console.log('ðŸ“‹ Validation errors:', response.body.details)
      return true
    } else {
      console.log(`âŒ Validation test failed - expected 400, got ${response.statusCode}`)
      return false
    }
  } catch (error) {
    console.log('âŒ Validation test error:', error.message)
    return false
  }
}

/**
 * Main test runner
 */
async function runTests() {
  console.log('ðŸš€ Starting Private CRM Integration Tests\n')
  console.log('=' .repeat(60))
  
  // Check configuration
  if (!CONFIG.PRIVATE_CRM_ENDPOINT || !CONFIG.PRIVATE_CRM_API_KEY) {
    console.log('âŒ Missing configuration!')
    console.log('ðŸ“ Please set these environment variables:')
    console.log('   PRIVATE_CRM_ENDPOINT=https://constructify-private.com/api/receive-lead')
    console.log('   PRIVATE_CRM_API_KEY=your_api_key_here')
    console.log('\nðŸ’¡ Or update the CONFIG object in this script')
    process.exit(1)
  }
  
  const tests = [
    { name: 'Connection Test', fn: testConnection },
    { name: 'Lead Submission Test', fn: testLeadSubmission },
    { name: 'Security Test', fn: testSecurity },
    { name: 'Validation Test', fn: testValidation }
  ]
  
  let passed = 0
  let failed = 0
  
  for (const test of tests) {
    try {
      const result = await test.fn()
      if (result) {
        passed++
      } else {
        failed++
      }
    } catch (error) {
      console.log(`âŒ ${test.name} crashed:`, error.message)
      failed++
    }
  }
  
  console.log('\n' + '=' .repeat(60))
  console.log('ðŸ“Š Test Results:')
  console.log(`âœ… Passed: ${passed}`)
  console.log(`âŒ Failed: ${failed}`)
  console.log(`ðŸ“ˆ Success Rate: ${Math.round((passed / (passed + failed)) * 100)}%`)
  
  if (failed === 0) {
    console.log('\nðŸŽ‰ All tests passed! Private CRM integration is working correctly.')
  } else {
    console.log('\nâš ï¸  Some tests failed. Please check the configuration and try again.')
  }
  
  console.log('\nðŸ”§ Next Steps:')
  console.log('1. If tests passed, the integration is ready for production')
  console.log('2. If tests failed, check environment variables and API configuration')
  console.log('3. Monitor the private CRM dashboard for incoming leads')
  console.log('4. Set up alerts for hot leads requiring immediate follow-up')
}

// Run tests if this script is executed directly
if (require.main === module) {
  runTests().catch(error => {
    console.error('ðŸ’¥ Test runner crashed:', error)
    process.exit(1)
  })
}

module.exports = {
  runTests,
  testConnection,
  testLeadSubmission,
  testSecurity,
  testValidation
} 